<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HCNå…¨èƒ½å·¥ä½œå° Pro</title>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #f0f3f7; font-family: -apple-system, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .tab-content { display: none; padding: 10px; flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .tab-content.active { display: block; }
        #tab5 { padding: 0; overflow: hidden; }

        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #fff; display: flex; border-top: 1px solid #e0e0e0; z-index: 9999; }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #8a8a8a; font-size: 10px; cursor: pointer; }
        .tab-item.active { color: #4a90e2; font-weight: bold; }
        .tab-icon { font-size: 20px; margin-bottom: 2px; }

        .controls { max-width: 500px; margin: 0 auto 15px; background: #fff; padding: 18px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .row { margin-bottom: 12px; }
        label { font-size: 12px; font-weight: bold; color: #666; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none; background: #fff; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
        .btn-main { padding: 12px 5px; border: none; border-radius: 8px; font-weight: bold; color: #fff; cursor: pointer; font-size: 13px; }

        .copyright-info { background: #FFD700; color: #333; padding: 10px; margin-top: 15px; font-size: 11px; border-radius: 8px; text-align: center; line-height: 1.4; border: 1px solid #DAA520; }

        #container { margin: 15px auto; display: flex; flex-direction: column; align-items: center; }
        .page-wrapper { background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 12px; overflow: hidden; position: relative; border: 0.1px solid #eee; }
        .size-100-100 { width: 100mm; height: 100mm; }
        .size-100-50 { width: 100mm; height: 50mm; }
        .size-80-80 { width: 80mm; height: 80mm; }

        .label-content { width: 100%; height: 100%; padding: 4mm; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        .header-mode { width: 100%; text-align: center; font-size: 18px; font-weight: bold; border-bottom: 2.5px solid #000; padding-bottom: 1.5mm; }
        .big-qty { font-size: 32px; font-weight: 900; line-height: 1.1; }
        .big-tracking { font-size: 18px; font-weight: 900; font-family: monospace; border-top: 2px solid #000; border-bottom: 2px solid #000; padding: 1.5mm 0; margin: 1.5mm 0; width: 100%; text-align: center; }
        .code-area { width: 100%; flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .barcode-img { max-width: 100%; height: auto; }
        .qrcode-img { height: 100%; width: auto; max-height: 130px; }
        .footer-made { width: 100%; border: 2px solid #000; text-align: center; font-size: 16px; font-weight: bold; padding: 1mm; }

        .module-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .title { font-size: 15px; font-weight: bold; margin-bottom: 10px; border-left: 4px solid #4a90e2; padding-left: 8px; }
        .temp-big { font-size: 48px; font-weight: bold; text-align: center; color: #4a90e2; margin: 10px 0; }
        .weather-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .weather-item { background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 13px; }

        /* --- æ—¥å†æ¨¡å—å¢å¼ºæ ·å¼ --- */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #eee; }
        .cal-cell { 
            background: #fff; 
            height: 60px; /* å¢åŠ é«˜åº¦æ˜¾ç¤ºå†œå† */
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            font-size: 14px; 
            position: relative;
            cursor: pointer;
        }
        .lunar-text { font-size: 10px; color: #999; margin-top: 2px; }
        .weekend-text { color: #e74c3c; } /* å‘¨æœ«æ–‡å­—é¢œè‰² */
        .event-dot { 
            position: absolute; 
            bottom: 4px; 
            width: 4px; 
            height: 4px; 
            background: #4a90e2; 
            border-radius: 50%; 
        }
        .today-circle { background: #4a90e2; color: #fff; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }

        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: white; padding: 10px 20px; border-radius: 20px; z-index: 10000; opacity: 0; transition: 0.3s; pointer-events: none; font-size: 13px; }
        .toast.show { opacity: 1; top: 30px; }
    </style>
</head>
<body>

<div id="tab1" class="tab-content active">
    <div class="controls">
        <div class="row">
            <label>è¿è¾“æ–¹å¼</label>
            <select id="mode" onchange="toggleCustomMode()">
                <option>å¤§é™†é£æ—¥æœ¬ğŸ‡¯ğŸ‡µ</option><option>é¦™æ¸¯é£æ—¥æœ¬ğŸ‡¯ğŸ‡µ</option><option>å›½é™…å¿«é€’</option>
                <option>æ™®èˆ¹æµ·è¿GS</option><option>æ™®èˆ¹æµ·è¿åŒ…ç¨</option><option>å¿«èˆ¹åŒ…ç¨</option>
                <option>æ™®èˆ¹å•†ä¸šä»¶</option><option>å¿«èˆ¹å•†ä¸šä»¶</option><option>20å‘æ•´æŸœå•†ä¸šä»¶</option>
                <option>40å‘æ•´æŸœå•†ä¸šä»¶</option><option>ä½å·å°åŒ…</option><option>EMSå¿«é€’</option>
                <option>ç©ºè¿è¶…å¤§ä»¶</option> <option>æµ·è¿è¶…å¤§ä»¶</option>
                <option>é£Ÿå“å±Š</option><option>é£Ÿå“ä¸“çº¿</option>
                <option>æ—¥æœ¬ä»“ç”µæ± </option><option>æ—¥æœ¬ğŸ‡¯ğŸ‡µå›å›½</option>
                <option>HCN Supply Chain (Shenzhen) Co., Ltd.</option>
                <option value="CUSTOM">-- æ‰‹åŠ¨è¾“å…¥ --</option>
            </select>
            <input type="text" id="custom-mode-input" placeholder="è¾“å…¥è¿è¾“æ–¹å¼" style="display:none; margin-top:8px;">
        </div>
        <div style="display:flex; gap:10px;" class="row">
            <div style="flex:1"><label>çº¸å¼ æ ¼å¼</label><select id="label-size"><option value="size-100-100">100mm x 100mm</option><option value="size-100-50">100mm x 50mm</option><option value="size-80-80">80mm x 80mm</option></select></div>
            <div style="flex:1"><label>ç åˆ¶ç±»å‹</label><select id="code-type"><option value="BARCODE">æ¡å½¢ç </option><option value="QRCODE">äºŒç»´ç </option></select></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1.5"><label>å•å·å‰ç¼€</label><input type="text" id="prefix" value="HCN"></div>
            <div style="flex:1"><label>æ€»ä»¶æ•°</label><input type="number" id="qty" value="1" min="1"></div>
        </div>
        <div class="btn-group">
            <button class="btn-main" style="background:#4a90e2" onclick="handleGenerate()">1. é¢„è§ˆæ ‡ç­¾</button>
            <button class="btn-main" style="background:#6c5ce7" onclick="copyInfo()">2. å¤åˆ¶ä¿¡æ¯</button>
            <button class="btn-main" style="background:#28a745" id="btn-share" onclick="handleExportPDF()">3. åˆ†äº« PDF</button>
            <button class="btn-main" style="background:#f39c12" onclick="handleExportCSV()">4. å¯¼å‡º CSV</button>
        </div>
        <div class="copyright-info">
            <div style="font-weight:bold; color: #000;">Â© HCN Supply Chain (Shenzhen) Co., Ltd.</div>
            <div>æ—¥æœ¬è·¨å¢ƒç‰©æµè”ç³»ğŸ“ Joyhua 19867541192</div>
        </div>
    </div>
    <div id="container"></div>
</div>

<div id="tab2" class="tab-content">
    <div class="module-card">
        <div class="title">ğŸŒ¤ï¸ å®æ—¶æ°”è±¡å°</div>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <input type="text" id="city-input" placeholder="åŸå¸‚æ‹¼éŸ³ (å¦‚: Shenzhen)" style="flex:1">
            <button onclick="getRichWeather()" id="weather-btn" style="width:80px; background:#4a90e2; color:#fff; border-radius:8px; border:none;">æŸ¥è¯¢</button>
        </div>
        <div id="weather-detail-box">
            <div class="temp-big" id="w-temp">--Â°C</div>
            <div id="w-desc" style="text-align:center; margin-bottom:15px; font-weight:bold; color:#666;">è¯·è¾“å…¥åŸå¸‚</div>
            <div class="weather-grid">
                <div class="weather-item"><b>ğŸŒ¬ï¸ é£é€Ÿ</b> <span id="w-wind">--</span></div>
                <div class="weather-item"><b>ğŸ’§ æ¹¿åº¦</b> <span id="w-hum">--</span></div>
                <div class="weather-item"><b>ğŸŒ… æ—¥å‡º</b> <span id="w-sunr">--</span></div>
                <div class="weather-item"><b>ğŸŒ‡ æ—¥è½</b> <span id="w-suns">--</span></div>
            </div>
        </div>
    </div>
</div>

<div id="tab3" class="tab-content">
    <div class="module-card">
        <div class="title">æ±‡ç‡è½¬æ¢</div>
        <input type="number" id="val-left" value="1000" oninput="convertRate('left')" style="font-size:24px; text-align:center; margin-bottom:10px;">
        <select id="cur-left" onchange="convertRate('left')" style="margin-bottom:15px;">
            <option value="JPY" selected>JPY æ—¥å¸</option>
            <option value="USD">USD ç¾å…ƒ</option>
            <option value="EUR">EUR æ¬§å…ƒ</option>
            <option value="CNY">CNY äººæ°‘å¸</option> 
            <option value="AUD">AUD æ¾³å…ƒ</option> 
            <option value="GBP">GBP è‹±é•‘</option> 
            <option value="NZD">NZD çº½å…ƒ</option>
            <option value="CAD">CAD åŠ å…ƒ</option> 
            <option value="TWD">TWD æ–°å°å¸</option> 
            <option value="HKD">HKD æ¸¯å…ƒ</option> 
            <option value="KRW">KRW éŸ©å…ƒ</option> 
            <option value="CHF">CHF ç‘å£«æ³•éƒ</option> 
            <option value="THB">THB æ³°é“¢</option> 
            <option value="SGD">SGD æ–°åŠ å¡å…ƒ</option>
        </select>
        <div style="text-align:center; font-size:30px; color:#4a90e2; margin:10px 0;">â‡…</div>
        <input type="number" id="val-right" oninput="convertRate('right')" style="font-size:24px; text-align:center; margin-bottom:10px;">
        <select id="cur-right" onchange="convertRate('right')">
            <option value="CNY" selected>CNY äººæ°‘å¸</option> 
            <option value="USD">USD ç¾å…ƒ</option>
            <option value="EUR">EUR æ¬§å…ƒ</option>
            <option value="JPY">JPY æ—¥å…ƒ</option> 
            <option value="AUD">AUD æ¾³å…ƒ</option> 
            <option value="GBP">GBP è‹±é•‘</option> 
            <option value="NZD">NZD çº½å…ƒ</option>
            <option value="CAD">CAD åŠ å…ƒ</option> 
            <option value="TWD">TWD æ–°å°å¸</option> 
            <option value="HKD">HKD æ¸¯å…ƒ</option> 
            <option value="KRW">KRW éŸ©å…ƒ</option> 
            <option value="CHF">CHF ç‘å£«æ³•éƒ</option> 
            <option value="THB">THB æ³°é“¢</option> 
            <option value="SGD">SGD æ–°åŠ å¡å…ƒ</option>
        </select>
    </div>
</div>

<div id="tab4" class="tab-content">
    <div class="module-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <button onclick="changeMonth(-1)" style="border:none; background:none; font-size:20px;">â—€</button>
            <div id="cal-month-title" style="font-weight:bold;"></div>
            <button onclick="changeMonth(1)" style="border:none; background:none; font-size:20px;">â–¶</button>
        </div>
        <div class="cal-grid" id="calendar-grid"></div>
        <div style="font-size: 11px; color:#999; margin-top:10px; text-align:center;">ğŸ’¡ ç‚¹å‡»æ—¥æœŸæ·»åŠ å¤‡æ³¨ï¼Œæœ‰å¤‡æ³¨æ—¥æœŸæ˜¾ç¤ºåœ†ç‚¹</div>
    </div>
</div>

<div id="tab5" class="tab-content">
    <div style="padding:10px; background:#fff; border-bottom:1px solid #eee; display:flex; gap:5px;">
        <input type="text" id="stock-search" placeholder="BINANCE:BTCUSDT" style="flex:1">
        <button onclick="updateStockChart()" style="background:#4a90e2; color:#fff; border:none; padding:0 15px; border-radius:8px;">æŸ¥çœ‹</button>
    </div>
    <div id="stock-chart-container" style="width:100%; height: calc(100vh - 120px);"></div>
</div>

<div class="tab-bar">
    <div class="tab-item active" onclick="switchTab(1)"><span class="tab-icon">ğŸ·ï¸</span><span>æ ‡ç­¾</span></div>
    <div class="tab-item" onclick="switchTab(2)"><span class="tab-icon">ğŸŒ¤ï¸</span><span>å¤©æ°”</span></div>
    <div class="tab-item" onclick="switchTab(3)"><span class="tab-icon">ğŸ’´</span><span>æ±‡ç‡</span></div>
    <div class="tab-item" onclick="switchTab(4)"><span class="tab-icon">ğŸ“…</span><span>æ—¥å†</span></div>
    <div class="tab-item" onclick="switchTab(5)"><span class="tab-icon">ğŸ“ˆ</span><span>è¡Œæƒ…</span></div>
</div>

<div id="toast" class="toast">æ“ä½œæˆåŠŸ</div>
<canvas id="temp-canvas" style="display:none;"></canvas>
<div id="qr-gen-box" style="display:none;"></div>

<script>
let lastBatchData = null;
let currDate = new Date();
let rates = {};
// å¤‡å¿˜å½•æ•°æ®åˆå§‹åŒ–
let memos = JSON.parse(localStorage.getItem('hcn_calendar_memos') || '{}');

window.onload = () => {
    initRates();
};

function switchTab(idx) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
    document.getElementById('tab' + idx).classList.add('active');
    document.querySelectorAll('.tab-item')[idx-1].classList.add('active');
    if(idx === 4) initCalendar();
    if(idx === 5) setTimeout(updateStockChart, 100);
}

// --- æ ‡ç­¾é€»è¾‘ ---
function toggleCustomMode() {
    const isCustom = document.getElementById('mode').value === "CUSTOM";
    document.getElementById('custom-mode-input').style.display = isCustom ? "block" : "none";
}

function handleGenerate() {
    const qty = parseInt(document.getElementById('qty').value) || 1;
    const prefix = document.getElementById('prefix').value || "HCN";
    const modeSelect = document.getElementById('mode');
    const modeText = (modeSelect.value === "CUSTOM") ? document.getElementById('custom-mode-input').value : modeSelect.options[modeSelect.selectedIndex].text;
    const sizeClass = document.getElementById('label-size').value;
    const codeType = document.getElementById('code-type').value;
    const container = document.getElementById('container');
    container.innerHTML = '';
    const now = new Date();
    const dateKey = now.toISOString().slice(2,10).replace(/-/g,'');
    const randomSuffix = Math.floor(Math.random() * 900 + 100);
    const mainTracking = `${prefix}${dateKey}${randomSuffix}`;
    lastBatchData = { mode: modeText, mainTracking: mainTracking, total: qty, date: now.toLocaleDateString(), size: sizeClass };
    for(let i=1; i<=qty; i++) {
        const displayLabel = `${i} / ${qty}`;
        const trackingWithCounter = `${mainTracking}-${i}`;
        const codeContent = `${trackingWithCounter} | ${displayLabel}`;
        const wrapper = document.createElement('div');
        wrapper.className = `page-wrapper ${sizeClass}`;
        let codeDataUrl = '';
        if(codeType === 'BARCODE') {
            const tempCanvas = document.getElementById('temp-canvas');
            JsBarcode(tempCanvas, codeContent, { format: "CODE128", width: 1.8, height: 70, displayValue: false, margin: 0 });
            codeDataUrl = tempCanvas.toDataURL('image/png');
        } else {
            const qrBox = document.getElementById('qr-gen-box');
            qrBox.innerHTML = '';
            new QRCode(qrBox, { text: codeContent, width: 250, height: 250, correctLevel: QRCode.CorrectLevel.M });
            codeDataUrl = qrBox.querySelector('canvas').toDataURL('image/png');
        }
        wrapper.innerHTML = `<div class="label-content"><div class="header-mode">${modeText}</div><div style="text-align:center"><div class="big-qty">${displayLabel}</div><div class="big-tracking">${trackingWithCounter}</div></div><div class="code-area"><img src="${codeDataUrl}" class="${codeType==='BARCODE'?'barcode-img':'qrcode-img'}"></div><div class="footer-made">MADE IN CHINA</div></div>`;
        container.appendChild(wrapper);
    }
    showToast("é¢„è§ˆå·²ç”Ÿæˆ");
}

async function handleExportPDF() {
    const pages = document.querySelectorAll('.page-wrapper');
    if(pages.length === 0) return alert("è¯·å…ˆç”Ÿæˆé¢„è§ˆ");
    const btn = document.getElementById('btn-share');
    btn.innerText = "ç”Ÿæˆä¸­...";
    const dims = { 'size-100-100': [100, 100], 'size-100-50': [100, 50], 'size-80-80': [80, 80] }[lastBatchData.size];
    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ unit: 'mm', format: dims, compress: true });
        for (let i = 0; i < pages.length; i++) {
            const canvas = await html2canvas(pages[i], { scale: 2 });
            if (i > 0) pdf.addPage(dims);
            pdf.addImage(canvas.toDataURL('image/jpeg', 0.8), 'JPEG', 0, 0, dims[0], dims[1], undefined, 'FAST');
        }
        const fileName = `${lastBatchData.mode}_${lastBatchData.mainTracking}_${lastBatchData.total}ä»¶.pdf`;
        const pdfBlob = pdf.output('blob');
        const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });
        if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
            await navigator.share({ files: [pdfFile], title: 'HCNç‰©æµæ ‡ç­¾' });
        } else {
            pdf.save(fileName);
        }
    } catch (err) { alert("ç”Ÿæˆå¤±è´¥"); }
    finally { btn.innerText = "3. åˆ†äº« PDF"; }
}

function copyInfo() {
    if(!lastBatchData) return alert("è¯·å…ˆç”Ÿæˆé¢„è§ˆ");
    const info = `æ—¥æœŸ: ${lastBatchData.date}\nå•å·: ${lastBatchData.mainTracking}\nä»¶æ•°: ${lastBatchData.total}ä»¶\nè¿è¾“: ${lastBatchData.mode}`;
    navigator.clipboard.writeText(info).then(() => showToast("ä¿¡æ¯å·²å¤åˆ¶"));
}

function handleExportCSV() {
    if(!lastBatchData) return alert("è¯·å…ˆç”Ÿæˆé¢„è§ˆ");
    const csvContent = "\ufeffè¿è¾“æ–¹å¼,ä¸»å•å·,æ€»ä»¶æ•°,æ—¥æœŸ\n" + `"${lastBatchData.mode}","${lastBatchData.mainTracking}",${lastBatchData.total},"${lastBatchData.date}"`;
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${lastBatchData.mainTracking}.csv`;
    link.click();
}

// --- æ±‡ç‡è½¬æ¢é€»è¾‘ ---
async function initRates() {
    try {
        const res = await fetch('https://open.er-api.com/v6/latest/USD');
        const data = await res.json();
        if(data && data.rates) {
            rates = data.rates;
            convertRate('left');
        }
    } catch(e) { console.error("æ±‡ç‡åŠ è½½å¤±è´¥"); }
}

function convertRate(dir) {
    if(!rates || Object.keys(rates).length === 0) return;
    const from = document.getElementById('cur-left').value;
    const to = document.getElementById('cur-right').value;
    const l = document.getElementById('val-left');
    const r = document.getElementById('val-right');
    if(dir === 'left') {
        r.value = (l.value / rates[from] * rates[to]).toFixed(2);
    } else {
        l.value = (r.value / rates[to] * rates[from]).toFixed(2);
    }
}

// --- å¤©æ°” ---
async function getRichWeather() {
    const city = document.getElementById('city-input').value.trim() || 'Shenzhen';
    try {
        const res = await fetch(`https://wttr.in/${city}?format=j1`);
        const data = await res.json();
        const cur = data.current_condition[0];
        document.getElementById('w-temp').innerText = `${cur.temp_C}Â°C`;
        document.getElementById('w-desc').innerText = `${city} Â· ${cur.weatherDesc[0].value}`;
        document.getElementById('w-wind').innerText = `${cur.windspeedKmph} km/h`;
        document.getElementById('w-hum').innerText = `${cur.humidity}%`;
    } catch (e) { alert("æŸ¥è¯¢å¤±è´¥"); }
}

// --- ç²¾å‡†ä¿®æ”¹åçš„å¢å¼ºæ—¥å†é€»è¾‘ ---
function initCalendar() {
    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = '';
    const year = currDate.getFullYear();
    const month = currDate.getMonth();
    
    document.getElementById('cal-month-title').innerText = `${year}å¹´ ${month + 1}æœˆ`;
    
    // æ˜ŸæœŸè¡¨å¤´ï¼ˆæ ‡æ³¨å‘¨æœ«é¢œè‰²ï¼‰
    const weekLabels = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
    weekLabels.forEach((label, i) => {
        const colorClass = (i === 0 || i === 6) ? 'weekend-text' : '';
        grid.innerHTML += `<div class="cal-cell ${colorClass}" style="font-weight:bold;background:#f8f9fa;height:35px">${label}</div>`;
    });

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // ç©ºç™½å¡«å……
    for(let i=0; i<firstDay; i++) grid.innerHTML += `<div class="cal-cell"></div>`;

    // å¡«å……å…·ä½“æ—¥æœŸ
    for(let d=1; d<=daysInMonth; d++) {
        const dateKey = `${year}-${month+1}-${d}`;
        const dayOfWeek = new Date(year, month, d).getDay();
        const isToday = new Date().toDateString() === new Date(year, month, d).toDateString();
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        
        // å†œå†æ”¯æŒ
        const lunarDate = Lunar.fromDate(new Date(year, month, d));
        let lunarTxt = lunarDate.getJieQi() || lunarDate.getDayInChinese();
        if(lunarTxt === 'åˆä¸€') lunarTxt = lunarDate.getMonthInChinese() + 'æœˆ';

        const cell = document.createElement('div');
        cell.className = `cal-cell ${isWeekend ? 'weekend-text' : ''}`;
        cell.onclick = () => handleDateClick(dateKey);

        let content = isToday ? `<div class="today-circle">${d}</div>` : `<span>${d}</span>`;
        content += `<div class="lunar-text">${lunarTxt}</div>`;
        if(memos[dateKey]) content += `<div class="event-dot"></div>`;
        
        cell.innerHTML = content;
        grid.appendChild(cell);
    }
}

function handleDateClick(dateKey) {
    const oldMemo = memos[dateKey] || "";
    const newMemo = prompt(`${dateKey} å¤‡æ³¨ï¼š\n(è¾“å…¥ç©ºåˆ™æ¸…é™¤)`, oldMemo);
    if(newMemo !== null) {
        if(newMemo.trim() === "") delete memos[dateKey];
        else memos[dateKey] = newMemo;
        localStorage.setItem('hcn_calendar_memos', JSON.stringify(memos));
        initCalendar();
    }
}

function changeMonth(delta) { 
    currDate.setMonth(currDate.getMonth() + delta); 
    initCalendar(); 
}

// --- è¡Œæƒ… ---
function updateStockChart() {
    const symbol = document.getElementById('stock-search').value || "300446";
    document.getElementById('stock-chart-container').innerHTML = '';
    new TradingView.widget({
        "autosize": true,
        "symbol": symbol,
        "interval": "D",
        "timezone": "Etc/UTC",
        "theme": "light",
        "style": "1",
        "locale": "zh_CN",
        "toolbar_bg": "#f1f3f6",
        "enable_publishing": false,
        "hide_top_toolbar": true,
        "save_image": true,
        "container_id": "stock-chart-container",
        "studies": ["RSI@tv-basicstudies"]
    });
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2000);
}
</script>
</body>
</html>
