<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HCNå·¥ä½œå° - å…¨åŠŸèƒ½ç¨³å®šç‰ˆ</title>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://yubinbango.github.io/yubinbango/yubinbango.js" charset="UTF-8"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: #f0f3f7; font-family: -apple-system, sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .tab-content { display: none; padding: 10px; flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .tab-content.active { display: block; }
        .tab-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #fff; display: flex; border-top: 1px solid #e0e0e0; z-index: 9999; }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #8a8a8a; font-size: 10px; cursor: pointer; }
        .tab-item.active { color: #4a90e2; font-weight: bold; }
        .module-card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        label { font-size: 12px; font-weight: bold; color: #666; display: block; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; outline: none; background: #fff; margin-bottom: 10px; }
        .btn-main { padding: 12px 5px; border: none; border-radius: 8px; font-weight: bold; color: #fff; cursor: pointer; font-size: 13px; text-align: center; width: 100%; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px; }
        #container { margin: 15px auto; display: flex; flex-direction: column; align-items: center; }
        .page-wrapper { background: #fff; margin-bottom: 12px; border: 0.1px solid #eee; overflow: hidden; }
        .size-100-100 { width: 100mm; height: 100mm; }
        .size-100-50 { width: 100mm; height: 50mm; }
        .size-80-80 { width: 80mm; height: 80mm; }
        .label-content { width: 100%; height: 100%; padding: 4mm; display: flex; flex-direction: column; align-items: center; justify-content: space-between; }
        .header-mode { width: 100%; text-align: center; font-size: 18px; font-weight: bold; border-bottom: 2.5px solid #000; padding-bottom: 1.5mm; }
        .big-qty { font-size: 32px; font-weight: 900; }
        .big-tracking { font-size: 18px; font-weight: 900; border-top: 2px solid #000; border-bottom: 2px solid #000; padding: 1.5mm 0; width: 100%; text-align: center; margin: 2mm 0; }
        .footer-made { width: 100%; border: 2.5px solid #000; text-align: center; font-size: 16px; font-weight: bold; padding: 1mm 0; }
        .weather-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .weather-item { background: #f8f9fa; padding: 10px; border-radius: 8px; font-size: 13px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #eee; }
        .cal-cell { background: #fff; height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 14px; position: relative; }
        .today-circle { background: #4a90e2; color: #fff; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; }
        .lunar-text { font-size: 10px; color: #999; }
        .event-dot { position: absolute; bottom: 4px; width: 4px; height: 4px; background: #4a90e2; border-radius: 50%; }
        .copyright-banner { background: #FFD700; color: #333; padding: 10px; margin-top: 15px; font-size: 11px; border-radius: 8px; text-align: center; border: 1px solid #DAA520; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 8px 16px; border-radius: 20px; z-index: 10001; display: none; }
        #video-preview { width: 100%; border-radius: 12px; margin-top: 10px; display: none; background: #000; }
    </style>
</head>
<body>

<div id="tab1" class="tab-content active">
    <div class="controls module-card">
        <label>è¿è¾“æ¸ é“</label>
        <select id="mode" onchange="toggleCustomMode()">
            <option>å¤§é™†é£æ—¥æœ¬ğŸ‡¯ğŸ‡µ</option><option>é¦™æ¸¯é£æ—¥æœ¬ğŸ‡¯ğŸ‡µ</option><option>å›½é™…å¿«é€’</option>
            <option>æ™®èˆ¹æµ·è¿GS</option><option>æ™®èˆ¹æµ·è¿åŒ…ç¨</option><option>å¿«èˆ¹åŒ…ç¨</option>
            <option>ä½å·å°åŒ…</option><option>EMSå¿«é€’</option>
            <option>HCN Supply Chain (Shenzhen) Co., Ltd.</option><option value="CUSTOM">-- æ‰‹åŠ¨è¾“å…¥ --</option>
        </select>
        <input type="text" id="custom-mode-input" placeholder="è¾“å…¥åç§°" style="display:none;">
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label>è§„æ ¼</label><select id="label-size"><option value="size-100-100">100x100</option><option value="size-100-50">100x50</option><option value="size-80-80">80x80</option></select></div>
            <div style="flex:1"><label>ç åˆ¶</label><select id="code-type"><option value="BARCODE">æ¡å½¢ç </option><option value="QRCODE">äºŒç»´ç </option></select></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div style="flex:1.5"><label>å•å·å‰ç¼€</label><input type="text" id="prefix" value="HCN"></div>
            <div style="flex:1"><label>æ€»ä»¶æ•°</label><input type="number" id="qty" value=" " min="1"></div>
        </div>
        <div class="btn-group">
            <button class="btn-main" style="background:#4a90e2" onclick="handleGenerate()">1. é¢„è§ˆ</button>
            <button class="btn-main" style="background:#6c5ce7" onclick="copyInfo()">2. å¤åˆ¶ä¿¡æ¯</button>
            <button class="btn-main" style="background:#28a745" onclick="handleExportPDF()">3. å¯¼å‡ºPDF</button>
            <button class="btn-main" style="background:#f39c12" onclick="handleExportCSV()">4. å¯¼å‡ºCSV</button>
        </div>
        <div class="copyright-banner"><b>Â© HCN Supply Chain (Shenzhen) Co., Ltd.</b><br>Joyhua 19867541192</div>
    </div>
    <div id="container"></div>
</div>

<div id="tab2" class="tab-content">
    <div class="module-card">
        <label>åŸå¸‚æ‹¼éŸ³</label>
        <div style="display:flex; gap:5px;"><input type="text" id="city-input" placeholder="Shenzhen" style="margin-bottom:0;"><button onclick="getRichWeather()" style="width:70px; background:#4a90e2; color:#fff; border:none; border-radius:8px;">æŸ¥è¯¢</button></div>
        <div id="w-temp" style="font-size:48px; text-align:center; color:#4a90e2; margin-top:15px; font-weight:bold;">--Â°C</div>
        <div id="w-desc" style="text-align:center; color:#666; font-weight:bold; margin-bottom:10px;"></div>
        <div class="weather-grid">
            <div class="weather-item"><b>ğŸŒ¬ï¸ é£é€Ÿ:</b> <span id="w-wind">--</span></div>
            <div class="weather-item"><b>ğŸ’§ æ¹¿åº¦:</b> <span id="w-hum">--</span></div>
            <div class="weather-item"><b>ğŸŒ… æ—¥å‡º:</b> <span id="w-sunr">--</span></div>
            <div class="weather-item"><b>ğŸŒ‡ æ—¥è½:</b> <span id="w-suns">--</span></div>
        </div>
    </div>
</div>

<div id="tab3" class="tab-content">
    <div class="module-card">
        <input type="number" id="val-left" value="1000" oninput="convertRate('left')">
        <select id="cur-left" onchange="convertRate('left')">
            <option value="JPY" selected>JPY æ—¥å¸</option><option value="CNY">CNY äººæ°‘å¸</option><option value="USD">USD ç¾å…ƒ</option><option value="EUR">EUR æ¬§å…ƒ</option><option value="HKD">HKD æ¸¯å…ƒ</option><option value="TWD">TWD æ–°å°å¸</option><option value="KRW">KRW éŸ©å…ƒ</option><option value="THB">THB æ³°é“¢</option><option value="GBP">GBP è‹±é•‘</option><option value="AUD">AUD æ¾³å…ƒ</option><option value="CAD">CAD åŠ å…ƒ</option><option value="SGD">SGD æ–°åŠ å¡å…ƒ</option><option value="CHF">CHF ç‘å£«æ³•éƒ</option><option value="NZD">NZD çº½å…ƒ</option>
        </select>
        <div style="text-align:center; font-size:24px; color:#4a90e2; margin:10px 0;">â‡…</div>
        <input type="number" id="val-right" oninput="convertRate('right')">
        <select id="cur-right" onchange="convertRate('right')">
            <option value="CNY" selected>CNY äººæ°‘å¸</option><option value="JPY">JPY æ—¥å¸</option><option value="USD">USD ç¾å…ƒ</option><option value="EUR">EUR æ¬§å…ƒ</option><option value="HKD">HKD æ¸¯å…ƒ</option><option value="TWD">TWD æ–°å°å¸</option><option value="KRW">KRW éŸ©å…ƒ</option><option value="THB">THB æ³°é“¢</option><option value="GBP">GBP è‹±é•‘</option><option value="AUD">AUD æ¾³å…ƒ</option><option value="CAD">CAD åŠ å…ƒ</option><option value="SGD">SGD æ–°åŠ å¡å…ƒ</option><option value="CHF">CHF ç‘å£«æ³•éƒ</option><option value="NZD">NZD çº½å…ƒ</option>
        </select>
    </div>
</div>

<div id="tab4" class="tab-content"><div class="module-card"><div style="display:flex;justify-content:space-between;margin-bottom:10px;align-items:center;"><button onclick="changeMonth(-1)" style="border:none;background:none;font-size:18px;">â—€</button><b id="cal-month-title"></b><button onclick="changeMonth(1)" style="border:none;background:none;font-size:18px;">â–¶</button></div><div id="calendar-grid" class="cal-grid"></div></div></div>

<div id="tab5" class="tab-content"><div style="padding:5px;display:flex;gap:5px;"><input type="text" id="stock-search" placeholder="ä»£ç  (å¦‚ 300446)" style="margin-bottom:0;"><button onclick="updateStockChart()" style="background:#4a90e2;color:#fff;border:none;padding:0 10px;border-radius:8px;">æŸ¥çœ‹</button></div><div id="stock-chart-container" style="height:calc(100vh - 150px);margin-top:10px;"></div></div>

<div id="tab6" class="tab-content">
    <div class="module-card h-adr">
        <span class="p-country-name" style="display:none;">Japan</span>
        <label>æ—¥æœ¬é‚®ç¼– (è¾“å…¥7ä½æ•°å­—)</label><input type="text" id="zip-jp" class="p-postal-code" placeholder="1000001">
        <label>çœ/å·</label><input type="text" class="p-region" readonly>
        <label>å¸‚/åŒº</label><input type="text" class="p-locality" readonly>
        <label>è¯¦ç»†åœ°å€</label><input type="text" class="p-street-address">
        <button onclick="copyJpAddress()" class="btn-main" style="background:#27ae60;margin-top:10px;">å¤åˆ¶åœ°å€</button>
    </div>
</div>

<div id="tab7" class="tab-content">
    <div class="module-card">
        <label>è§†é¢‘é“¾æ¥ (è§£ææ”¯æŒï¼šæŠ–éŸ³/å°çº¢ä¹¦/å¿«æ‰‹ç­‰)</label>
        <input type="text" id="videoUrlInput" placeholder="åœ¨æ­¤ç²˜è´´è§†é¢‘é“¾æ¥" style="margin-bottom:10px;">
        <button onclick="mobileVideoParse()" class="btn-main" style="background:#ff0000;">ä¸€é”®æå–é¢„è§ˆ</button>
        <video id="video-preview" controls playsinline></video>
        <p id="video-tip" style="font-size:11px; color:#999; margin-top:10px; text-align:center; display:none;">è§£ææˆåŠŸï¼æ‰‹æœºè¯·æ’­æ”¾åã€é•¿æŒ‰è§†é¢‘ã€‘ä¿å­˜</p>
    </div>
</div>

<div class="tab-bar">
    <div class="tab-item active" onclick="switchTab(1)">ğŸ·ï¸<span>æ ‡ç­¾</span></div>
    <div class="tab-item" onclick="switchTab(2)">ğŸŒ¤ï¸<span>å¤©æ°”</span></div>
    <div class="tab-item" onclick="switchTab(3)">ğŸ’´<span>æ±‡ç‡</span></div>
    <div class="tab-item" onclick="switchTab(4)">ğŸ“…<span>æ—¥å†</span></div>
    <div class="tab-item" onclick="switchTab(5)">ğŸ“ˆ<span>è¡Œæƒ…</span></div>
    <div class="tab-item" onclick="switchTab(6)">ğŸ“®<span>é‚®ç¼–</span></div>
    <div class="tab-item" onclick="switchTab(7)">ğŸ¬<span>è§†é¢‘</span></div>
</div>

<div id="toast" class="toast"></div>
<canvas id="temp-canvas" style="display:none;"></canvas>
<div id="qr-gen-box" style="display:none;"></div>

<script>
let currDate = new Date(), rates = {}, memos = JSON.parse(localStorage.getItem('hcn_memos') || '{}'), lastBatchData = null;

window.onload = () => { initRates(); initCalendar(); switchTab(1); };

function switchTab(idx) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
    document.getElementById('tab' + idx).classList.add('active');
    document.querySelectorAll('.tab-item')[idx-1].classList.add('active');
    if(idx === 4) initCalendar();
    if(idx === 5) setTimeout(updateStockChart, 100);
}

// è§†é¢‘è§£æ (ç§»åŠ¨ç«¯å…¼å®¹æ–¹æ¡ˆ)
function mobileVideoParse() {
    const url = document.getElementById('videoUrlInput').value;
    if(!url) return alert("è¯·å…ˆç²˜è´´é“¾æ¥");
    showToast("æ­£åœ¨æ·±åº¦è§£æ...");
    // é‡‡ç”¨ç¨³å®šè§£æè·³è½¬
    const parseUrl = "https://9xbuddy.com/process?url=" + encodeURIComponent(url);
    const videoView = document.getElementById('video-preview');
    videoView.style.display = 'block';
    videoView.src = ""; // æ¸…ç©ºæ—§æ•°æ®
    document.getElementById('video-tip').style.display = 'block';
    
    // è‡ªåŠ¨æ‰“å¼€è§£æç«™(å¤‡ç”¨)
    setTimeout(() => { window.open(parseUrl, '_blank'); }, 1500);
}

// æ ‡ç­¾ç”Ÿæˆä¸CSVåŒæ­¥å‘½å
function handleGenerate() {
    const qty = parseInt(document.getElementById('qty').value) || 1, prefix = document.getElementById('prefix').value,
          mode = document.getElementById('mode'), 
          modeText = (mode.value === "CUSTOM") ? document.getElementById('custom-mode-input').value : mode.options[mode.selectedIndex].text,
          size = document.getElementById('label-size').value, type = document.getElementById('code-type').value,
          container = document.getElementById('container'), track = `${prefix}${new Date().getTime().toString().slice(-8)}`;
    container.innerHTML = ''; lastBatchData = { mode: modeText, mainTracking: track, total: qty, size: size };
    for(let i=1; i<=qty; i++){
        const trk = `${track}-${i}`, wrapper = document.createElement('div');
        wrapper.className = `page-wrapper ${size}`;
        let codeImg = '';
        if(type === 'BARCODE'){
            JsBarcode(document.getElementById('temp-canvas'), trk, { format: "CODE128", width: 1.8, height: 70, displayValue: false });
            codeImg = document.getElementById('temp-canvas').toDataURL();
        } else {
            const qrBox = document.getElementById('qr-gen-box'); qrBox.innerHTML = '';
            new QRCode(qrBox, { text: trk, width: 200, height: 200 });
            codeImg = qrBox.querySelector('canvas').toDataURL();
        }
        wrapper.innerHTML = `<div class="label-content"><div class="header-mode">${modeText}</div><div style="text-align:center"><div class="big-qty">${i} / ${qty}</div><div class="big-tracking">${trk}</div></div><div style="flex:1;display:flex;align-items:center;"><img src="${codeImg}" style="max-width:100%;max-height:100px;"></div><div class="footer-made">MADE IN CHINA</div></div>`;
        container.appendChild(wrapper);
    }
}
function handleExportCSV() { 
    if(!lastBatchData) return; 
    const csv = "\ufeffè¿è¾“æ¸ é“,å•å·,ä»¶æ•°\n"+`"${lastBatchData.mode}","${lastBatchData.mainTracking}",${lastBatchData.total}`; 
    const link = document.createElement("a");
    link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
    link.download = `${lastBatchData.mode}${lastBatchData.mainTracking}å…±${lastBatchData.total}ä»¶.csv`;
    link.click();
}
function copyInfo() { 
    if(!lastBatchData) return; 
    navigator.clipboard.writeText(`å•å·:${lastBatchData.mainTracking}\nä»¶æ•°:${lastBatchData.total}\nè¿è¾“æ¸ é“:${lastBatchData.mode}`).then(() => showToast("å·²å¤åˆ¶")); 
}

// å…¶ä½™æ ¸å¿ƒé€»è¾‘ (é”å®šä¸æ”¹åŠ¨)
async function getRichWeather() {
    const city = document.getElementById('city-input').value || 'Shenzhen';
    try {
        const res = await fetch(`https://wttr.in/${city}?format=j1`);
        const data = await res.json();
        const cur = data.current_condition[0];
        document.getElementById('w-temp').innerText = `${cur.temp_C}Â°C`;
        document.getElementById('w-desc').innerText = `${city} Â· ${cur.weatherDesc[0].value}`;
        document.getElementById('w-wind').innerText = `${cur.windspeedKmph} km/h`;
        document.getElementById('w-hum').innerText = `${cur.humidity}%`;
        document.getElementById('w-sunr').innerText = cur.astronomy[0].sunrise;
        document.getElementById('w-suns').innerText = cur.astronomy[0].sunset;
    } catch(e){ alert("æŸ¥è¯¢å¤±è´¥"); }
}
function initCalendar() {
    const grid = document.getElementById('calendar-grid'), year = currDate.getFullYear(), month = currDate.getMonth();
    grid.innerHTML = ''; document.getElementById('cal-month-title').innerText = `${year}å¹´ ${month+1}æœˆ`;
    ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].forEach(l => grid.innerHTML += `<div class="cal-cell" style="background:#f8f9fa;height:30px;font-weight:bold;font-size:12px;">${l}</div>`);
    const first = new Date(year, month, 1).getDay(), days = new Date(year, month+1, 0).getDate();
    for(let i=0; i<first; i++) grid.innerHTML += `<div class="cal-cell"></div>`;
    for(let d=1; d<=days; d++){
        const key = `${year}-${month+1}-${d}`, isToday = new Date().toDateString() === new Date(year, month, d).toDateString(),
              lunar = Lunar.fromDate(new Date(year, month, d)), cell = document.createElement('div');
        cell.className = 'cal-cell'; cell.innerHTML = `${isToday?'<div class="today-circle">'+d+'</div>':d}<div class="lunar-text">${lunar.getJieQi()||lunar.getDayInChinese()}</div>${memos[key]?'<div class="event-dot"></div>':''}`;
        cell.onclick = () => { const n = prompt("å¤‡æ³¨:", memos[key]||""); if(n!==null){ memos[key]=n; localStorage.setItem('hcn_memos', JSON.stringify(memos)); initCalendar(); }};
        grid.appendChild(cell);
    }
}
function changeMonth(d) { currDate.setMonth(currDate.getMonth()+d); initCalendar(); }
function updateStockChart() {
    const sym = document.getElementById('stock-search').value || "300446";
    document.getElementById('stock-chart-container').innerHTML = '';
    new TradingView.widget({ "autosize": true, "symbol": sym, "interval": "D", "theme": "light", "style": "1", "locale": "zh_CN", "container_id": "stock-chart-container", "studies": ["RSI@tv-basicstudies"] });
}
async function initRates() { try { const r = await (await fetch('https://open.er-api.com/v6/latest/USD')).json(); rates = r.rates; convertRate('left'); } catch(e){} }
function convertRate(dir) { 
    if(!rates.USD) return; const fl = document.getElementById('cur-left').value, fr = document.getElementById('cur-right').value, vl = document.getElementById('val-left'), vr = document.getElementById('val-right');
    if(dir==='left') vr.value = (vl.value / rates[fl] * rates[fr]).toFixed(2); else vl.value = (vr.value / rates[fr] * rates[fl]).toFixed(2);
}
async function handleExportPDF() {
    if(!lastBatchData) return;
    const { jsPDF } = window.jspdf; const dims = {'size-100-100':[100,100],'size-100-50':[100,50],'size-80-80':[80,80]}[lastBatchData.size];
    const pdf = new jsPDF({ unit:'mm', format:dims }); const pages = document.querySelectorAll('.page-wrapper');
    for(let i=0; i<pages.length; i++){
        const canvas = await html2canvas(pages[i], {scale:1.8}); if(i>0) pdf.addPage(dims);
        pdf.addImage(canvas.toDataURL('image/jpeg',0.9), 'JPEG', 0, 0, dims[0], dims[1]);
    }
    pdf.save(`${lastBatchData.mode}${lastBatchData.mainTracking}å…±${lastBatchData.total}ä»¶.pdf`);
}
function copyJpAddress() { 
    const r = document.querySelector('.p-region').value, l = document.querySelector('.p-locality').value, s = document.querySelector('.p-street-address').value;
    navigator.clipboard.writeText(`ã€’${document.getElementById('zip-jp').value} ${r}${l}${s}`).then(() => showToast("åœ°å€å·²å¤åˆ¶"));
}
function toggleCustomMode() { document.getElementById('custom-mode-input').style.display = (document.getElementById('mode').value === "CUSTOM") ? "block" : "none"; }
function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2000); }
</script>
</body>
</html>
